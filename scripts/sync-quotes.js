const https = require('https');
const fs = require('fs');
const path = require('path');

// Configuration
const SPREADSHEET_ID = '1u82fkDCYseizqTrZZfEjw3WcooUlFimvkf1AtGfM6dY';
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv`;
const OUTPUT_FILE = path.join(__dirname, '../quotes.js');

console.log('ðŸ”„ Fetching quotes from Google Sheet...');

function fetchData(url) {
    https.get(url, (res) => {
        // Handle Redirects (301, 302, 307, etc.)
        if (res.statusCode >= 300 && res.statusCode < 400 && res.headers.location) {
            console.log(`âž¡ï¸ Redirecting to: ${res.headers.location}`);
            return fetchData(res.headers.location);
        }

        if (res.statusCode !== 200) {
            console.error(`âŒ Failed to fetch data: Status Code ${res.statusCode}`);
            process.exit(1);
        }

        let rawData = '';
        res.on('data', (chunk) => { rawData += chunk; });

        res.on('end', () => {
            try {
                const quotes = parseCSV(rawData);
                console.log(`âœ… Extracted ${quotes.length} quotes.`);

                // Format as JS file
                const fileContent = `// Hindi Quotes Collection with Writer Names
// Auto-generated by scripts/sync-quotes.js

const quotes = ${JSON.stringify(quotes, null, 4)};
`;

                fs.writeFileSync(OUTPUT_FILE, fileContent);
                console.log(`âœ¨ Successfully updated quotes.js with ${quotes.length} quotes!`);

            } catch (e) {
                console.error('âŒ Error processing data:', e.message);
                process.exit(1);
            }
        });

    }).on('error', (e) => {
        console.error(`âŒ Request error: ${e.message}`);
        process.exit(1);
    });
}

// Simple CSV Parser that handles quoted fields
function parseCSV(csvText) {
    const lines = csvText.split(/\r?\n/);
    const result = [];

    // Skip empty lines
    const validLines = lines.filter(line => line.trim() !== '');

    for (let i = 0; i < validLines.length; i++) {
        const line = validLines[i];

        // CSV Parser Logic
        // Matches: "quoted value" OR unquoted_value
        const regex = /(?:^|,)(\"(?:[^\"]+|\"\")*\"|[^,]*)?/g;
        const row = [];
        let match;

        while ((match = regex.exec(line)) !== null) {
            let val = match[1] || '';
            // Remove quotes and unescape "" -> "
            if (val.startsWith('"') && val.endsWith('"')) {
                val = val.slice(1, -1).replace(/""/g, '"');
            }
            if (match[0] === ',' || match[0] === '') {
                // Logic check
            }

            row.push(val.trim());
        }

        const cleanRow = row.filter(pt => pt !== undefined && pt !== '');

        // Updated Logic for New Structure: [Index, Quote, Writer]
        // We expect at least 3 columns (or 2 if index is missing, but handling 3 is key)

        if (cleanRow.length >= 3) {
            // Structure: Index, Quote, Writer
            const text = cleanRow[1];
            const writer = cleanRow[2];

            // Skip Header
            if (text.toLowerCase() === 'quote' && writer.toLowerCase() === 'writer') continue;

            // Basic validation
            if (text && writer) {
                result.push({ text, writer });
            }
        } else if (cleanRow.length === 2 && isNaN(cleanRow[0])) {
            // Fallback for old structure or if index is missing: Quote, Writer
            // But only if first column is NOT a number (to distinguish from Index, Quote case where Writer is missing)
            // Actually, safest is to stick to the requested structure.
            // But if user reverts structure, this breaks.
            // Let's rely on column 1 being Quote if 3 cols exist.

            const text = cleanRow[0];
            const writer = cleanRow[1];
            if (text.toLowerCase() === 'quote' && writer.toLowerCase() === 'writer') continue;
            result.push({ text, writer });
        }
    }

    return result;
}

fetchData(CSV_URL);
